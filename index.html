<!doctype html>
<html lang="en">                                                                                                                                                                                                                               
   <head>
      <title>My first HTML document</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
      <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
      <script src="./model.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>
   </head>
   <body>
      <div id="app">

          <p>
          <h2 class="text-center">Lorawan devices</h2>
          <div class="container">

             <div v-if="success" id="success">
                 <div class="alert alert-success" role="alert">
                    Success with creating device <a href="#" class="alert-link">https://qa.wappsto.com/devices</a>. Give it a click to go.
                 </div>
             </div>
             <div v-if="failed" id="failed">
                 <div class="alert alert-warning" role="alert">
                    <ul >
                        <li v-for="err in errors">
                            {{err}}
                        </li>
                    </ul>
                 </div>
             </div>

            <table class="table table-sm table-hover">
              <thead>
                <tr class="table-info">
                  <th scope="col">#</th>
                  <th scope="col">Name</th>
                  <th scope="col">Device EUI</th>
                  <th scope="col">Manufacturer</th>
                  <th scope="col"></th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(dev, index) in network[0].device" v-bind:index="index">
                    <th scope="row">{{index+1}}</th>
                    <td>{{dev.name}}</td>
                    <td>{{dev.serial.toUpperCase()}}</td>
                    <td>{{dev.manufacturer}}</td>
                    <td><button class="btn btn-outline-danger" @click="fireDelete(dev.meta.id, index)">Delete</button></td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="container">
            <p>
            <h5 class="text-left">Create new device</h5>
            
            <form>
                <div class="col-lg-8">
                <div class="form-group">
                    <label for="name">Device name:</label>
                    <input type="text" id="name" class="form-control ml-2" v-model="device.name">
                </div> 
                <div class="form-group">
                    <label for="devEUI">Device EUI:</label>
                    <input type="text" id="devEUI" class="form-control ml-2" placeholder="0102030405060708" v-model="device.serial">
                    <small id="nameHelp" class="form-text text-muted">Device EUI should be 8 bytes HEX string.</small>
                </div>
                <div class="form-group">
                    <label for="manufacturer">Manufacturer:</label>
                    <input type="text" id="manufacturer" class="form-control ml-2" placeholder="Seluxit" v-model="device.manufacturer">
                    <small id="nameHelp" class="form-text text-muted">Manufacturer is optional, default value is 'Seluxit'</small>
                </div>
                    <button type="button" class="btn btn-primary" v-on:click="checkForm">Create</button>
                </div>
            </form>
          </div>

      </div>
    
    <script>
        var app = new Vue({
            el: '#app',
            async created() {
                console.log("Hello to Lorawan Device generator!");
                const requestOptions = {
                    method: 'GET',
                    headers: { 'Content-Type':'application/json','X-Session':'57336e29-270d-40be-91ff-047a6a442b95'}
                };
                const response = await fetch("https://qa.wappsto.com/services/network?expand=4", requestOptions);
                this.network = await response.json();
            },
            data: {
                errors: [],
                success: false,
                failed: false,
                message: "",
                device: generateDevice(),
                network: {}
            },
            methods: {
                checkForm: function(e) {
                    this.success = false;
                    this.failed = false;
                    if (this.device.name && this.device.serial) {
                        //this.success = true;
                        this.postNewDevice();
                        this.network[0].device.push(this.device);
                        return true;
                    }
                    this.errors = [];
                    if (!this.device.name) {
                        this.errors.push('Device name required!');
                    }
                    if (!this.device.serial) {
                        this.errors.push("Device EUI required!");
                    }
                    this.failed = true;
                    e.preventDefault();
                },
                postNewDevice: function() {
                    const requestOptions = {
                        method: 'POST',
                        headers: { 'Content-Type':'application/json','X-Session':'57336e29-270d-40be-91ff-047a6a442b95'},
                        body: JSON.stringify(this.device) 
                    };
                    fetch('https://qa.wappsto.com/services/network/'+this.network[0].meta.id+'/device', requestOptions)
                        .then(async response =>{
                            const data = await response.json();
                            if (!response.ok) {
                                console.error("Error+++++++")
                            } else {
                                this.success = true;
                            }
                        })
                        .catch(error => {
                            this.errors.push(error);
                            this.failed = true;
                            console.error('There was an erroe', error)
                        })
                },
                fireDelete: function(uuid, index) {
                    this.failed = false;
                    this.success = false;
                    const requestOptions = {
                        method: 'DELETE',
                        headers: { 'Content-Type':'application/json','X-Session':'57336e29-270d-40be-91ff-047a6a442b95'}
                    };
                    let url = "https://qa.wappsto.com/services/network/"+this.network[0].meta.id+"/device/"+uuid;
                    console.log("Warning - deleteting device: " + url);

                    fetch(url, requestOptions)
                        .then(async response =>{
                            const data = await response.json();
                            if (!response.ok) {
                                this.failed = true;
                                errors.push("Failed to delete device");
                                console.error("Failed to delete device with UUID: " + uuid);
                            } else {
                                console.log("Device deleted successfully!")
                                this.network[0].device.splice(index,1)
                            }
                        })
                        .catch(error => {
                            this.errors.push(error);
                            this.failed = true;
                            console.error('There was an erroe', error)
                        })
                }
            }
        })
    </script>
   </body>
</HTML>
